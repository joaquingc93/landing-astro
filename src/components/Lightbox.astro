---
// Lightbox component for image galleries
// Can be used in any page that needs lightbox functionality
import { normalizeMediaUrl } from '@/lib/media-url';
---

<!-- Lightbox Overlay (simplified) -->
<div id="lightbox-overlay" class="lb-hidden" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="lb-stage" role="document">
    <figure class="lb-figure">
      <img id="lb-image" class="lb-image" alt="" src="" />
      <figcaption class="lb-meta">
        <span id="lb-title" class="lb-title"></span>
        <span id="lb-counter" class="lb-counter"></span>
      </figcaption>
    </figure>
    <button id="lb-close" class="lb-btn lb-close" aria-label="Close (Esc)">
      <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
    </button>
    <button id="lb-prev" class="lb-btn lb-prev" aria-label="Previous (←)">
      <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
    </button>
    <button id="lb-next" class="lb-btn lb-next" aria-label="Next (→)">
      <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
    </button>
  </div>
</div>

<style>
/* Root overlay */
#lightbox-overlay { position:fixed; top:0; left:0; right:0; bottom:0; width:100vw; height:100vh; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.9); backdrop-filter:blur(6px); -webkit-backdrop-filter:blur(6px); z-index:9999; padding:0; margin:0; }
.lb-no-transform { transform:none !important; }
#lightbox-overlay.lb-hidden { opacity:0; visibility:hidden; pointer-events:none; }
#lightbox-overlay.lb-visible { opacity:1; visibility:visible; }
#lightbox-overlay { transition:opacity .25s ease, visibility .25s ease; }

/* Stage centers content */
.lb-stage { position:relative; max-width: min(1200px, 92vw); max-height:92vh; width:100%; height:auto; display:flex; flex-direction:column; align-items:center; justify-content:center; }

/* Figure and image */
.lb-figure { position:relative; margin:0; display:flex; flex-direction:column; align-items:center; justify-content:center; max-height:92vh; }
.lb-image { max-width:100%; max-height:82vh; width:auto; height:auto; object-fit:contain; border-radius:14px; box-shadow:0 10px 40px -10px rgba(0,0,0,.6); background:#111; }

/* Meta (title + counter) */
.lb-meta { position:absolute; left:0; right:0; bottom:0; padding:1rem 1.1rem 1.25rem; display:flex; flex-direction:column; align-items:flex-start; gap:.4rem; color:#fff; font-family:system-ui, sans-serif; background:linear-gradient(to top, rgba(0,0,0,.9), rgba(0,0,0,.45), rgba(0,0,0,0)); border-radius:0 0 14px 14px; pointer-events:none; }
.lb-title { font-size:1rem; font-weight:600; text-shadow:0 2px 4px rgba(0,0,0,.55); }
.lb-counter { font-size:.65rem; letter-spacing:.08em; text-transform:uppercase; opacity:.82; font-weight:500; }

/* Buttons (close + nav) */
.lb-btn { position:absolute; background:rgba(0,0,0,.55); color:#fff; border:none; padding:.65rem; border-radius:9999px; display:flex; align-items:center; justify-content:center; cursor:pointer; line-height:0; transition:background .2s, transform .2s; backdrop-filter:blur(4px); -webkit-backdrop-filter:blur(4px); }
.lb-btn:hover { background:rgba(0,0,0,.75); transform:scale(1.06); }
.lb-close { top:1rem; right:1rem; }
.lb-prev, .lb-next { top:50%; transform:translateY(-50%); background:rgba(0,0,0,.55); }
.lb-prev { left:1rem; }
.lb-next { right:1rem; }
.lb-prev:hover, .lb-next:hover { background:rgba(0,0,0,.8); }

@media (max-width:640px) {
  .lb-image { max-height:70vh; }
  .lb-prev, .lb-next { padding:.55rem; }
  .lb-title { font-size:.95rem; }
}
</style>

<script>
// @ts-nocheck Simplified Lightbox implementation
(function(){
  function safe(url){ try { return (typeof normalizeMediaUrl==='function'? (normalizeMediaUrl(url)||url):url); } catch { return url; } }
  let images = []; let index = 0;
  let overlay, imgEl, titleEl, counterEl, prevBtn, nextBtn, closeBtn;

  function cacheEls(){
    overlay = document.getElementById('lightbox-overlay');
    // Ensure overlay is a direct child of body to avoid clipping/stacking issues
    if(overlay && overlay.parentElement !== document.body){
      document.body.appendChild(overlay);
    }
    if(!overlay) return false;
    imgEl = document.getElementById('lb-image');
    titleEl = document.getElementById('lb-title');
    counterEl = document.getElementById('lb-counter');
    prevBtn = document.getElementById('lb-prev');
    nextBtn = document.getElementById('lb-next');
    closeBtn = document.getElementById('lb-close');
    return true;
  }

  function setVisible(v){
    if(!overlay) return;
    if(v){
      // Disable any transform on body (page-loading/page-loaded) to allow fixed overlay to truly cover viewport
      if(!document.body.dataset.lbPrevTransform){
        document.body.dataset.lbPrevTransform = document.body.style.transform || '';
      }
      document.body.classList.add('lb-no-transform');
      document.body.style.transform = 'none';
      overlay.classList.remove('lb-hidden'); overlay.classList.add('lb-visible');
      document.body.style.overflow='hidden';
    } else {
      overlay.classList.add('lb-hidden'); overlay.classList.remove('lb-visible');
      document.body.style.overflow='';
      // Restore transform
      if(document.body.dataset.lbPrevTransform !== undefined){
        document.body.style.transform = document.body.dataset.lbPrevTransform;
        delete document.body.dataset.lbPrevTransform;
      } else {
        document.body.style.transform = '';
      }
      document.body.classList.remove('lb-no-transform');
    }
  }

  function update(){
    const item = images[index]; if(!item||!imgEl) return;
    imgEl.src = safe(item.url); imgEl.alt = item.alt||'';
    if(titleEl) titleEl.textContent = item.title||'';
    if(counterEl) counterEl.textContent = `${index+1} / ${images.length}`;
    if(prevBtn && nextBtn){ const multi = images.length>1; prevBtn.style.display = multi?'flex':'none'; nextBtn.style.display = multi?'flex':'none'; }
  }

  function open(i){ if(!images.length) return; index = i; update(); setVisible(true); }
  function close(){ setVisible(false); }
  function nav(dir){ if(!images.length) return; index = dir==='prev'? (index>0?index-1:images.length-1) : (index<images.length-1?index+1:0); update(); }

  function buildProjectImages(projectId){
    const projectsData = (window.projectsData)||[]; const project = projectsData.find(p=>p.id && p.id.toString()===projectId?.toString());
    const out=[]; if(!project) return out;
    if(project.acf && Array.isArray(project.acf.project_gallery)){
      project.acf.project_gallery.forEach((img,i)=>{ out.push({ url:img.url, alt:img.alt||project.title?.rendered||'', title:`${project.title?.rendered||'Project'} - Image ${i+1}` }); });
    } else {
      const acf = project.acf_fields || project.acf || {}; for(let i=1;i<=6;i++){ const f = acf[`project_image_${i}`]; if(f&&f.url){ out.push({ url:safe(f.url), alt:f.alt||project.title?.rendered||'', title:`${project.title?.rendered||'Project'} - Image ${out.length+1}` }); } }
    }
    return out;
  }

  function init(){ if(!cacheEls()) return; images=[]; index=0;
    const triggers = document.querySelectorAll('.gallery-image-trigger, .project-image, .gallery-trigger');
    let seq=0;
    triggers.forEach((t)=>{
      if(t.classList.contains('gallery-trigger')){
        t.addEventListener('click',e=>{ e.preventDefault(); e.stopPropagation(); const pid=t.getAttribute('data-project-id'); const list=buildProjectImages(pid); if(list.length){ images=list; open(0);} });
        t.style.cursor='pointer'; return;
      }
      const img=t.querySelector('img'); const ds=t.dataset||{};
      const item={ url: ds.imageUrl || (img&&img.src) || '', alt: ds.imageAlt || (img&&img.alt) || '', title: ds.imageTitle || ds.projectTitle || `Image ${seq+1}` };
      images.push(item); const thisIndex=seq; t.addEventListener('click',e=>{ e.preventDefault(); e.stopPropagation(); open(thisIndex); }); t.style.cursor='pointer'; seq++;
    });
    if(prevBtn) prevBtn.addEventListener('click', ()=>nav('prev'));
    if(nextBtn) nextBtn.addEventListener('click', ()=>nav('next'));
    if(closeBtn) closeBtn.addEventListener('click', close);
    if(overlay) overlay.addEventListener('click', e=>{ if(e.target===overlay) close(); });
    document.addEventListener('keydown', e=>{ if(!overlay || overlay.classList.contains('lb-hidden')) return; if(e.key==='Escape') close(); if(e.key==='ArrowLeft') nav('prev'); if(e.key==='ArrowRight') nav('next'); });
    update();
  }

  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init); } else { init(); }
  document.addEventListener('astro:page-load', init);
})();
</script>