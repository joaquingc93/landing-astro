# RenovaLink Headless WordPress .htaccess Configuration

# WordPress Standard Rules
# BEGIN WordPress
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
RewriteBase /
RewriteRule ^index\.php$ - [L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /index.php [L]
</IfModule>
# END WordPress

# Security Enhancements
<IfModule mod_headers.c>
    # Security Headers
    Header always set X-Frame-Options SAMEORIGIN
    Header always set X-XSS-Protection "1; mode=block"
    Header always set X-Content-Type-Options nosniff
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    
    # CORS Headers for API
    Header add Access-Control-Allow-Origin "*"
    Header add Access-Control-Allow-Methods "GET, POST, OPTIONS"
    Header add Access-Control-Allow-Headers "Origin, Content-Type, Accept, Authorization, X-Request-With"
    Header add Access-Control-Allow-Credentials "true"
</IfModule>

# Cache Control
<IfModule mod_expires.c>
    ExpiresActive On
    
    # API Responses
    ExpiresByType application/json "access plus 5 minutes"
    
    # Images
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    
    # CSS and JavaScript
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    
    # HTML
    ExpiresByType text/html "access plus 1 hour"
    
    # Fonts
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/ttf "access plus 1 year"
    ExpiresByType font/eot "access plus 1 year"
</IfModule>

# Compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
</IfModule>

# Protect sensitive files
<Files "wp-config.php">
    Order Allow,Deny
    Deny from all
</Files>

<Files ".htaccess">
    Order Allow,Deny
    Deny from all
</Files>

<Files "readme.html">
    Order Allow,Deny
    Deny from all
</Files>

<Files "wp-config-sample.php">
    Order Allow,Deny
    Deny from all
</Files>

# Block access to wp-includes and wp-admin for non-logged users
<IfModule mod_rewrite.c>
    # Block access to wp-includes
    RewriteCond %{REQUEST_URI} wp-includes
    RewriteCond %{REQUEST_URI} !wp-includes/js/
    RewriteCond %{REQUEST_URI} !wp-includes/css/
    RewriteRule ^(.*)$ - [F,L]
    
    # Allow REST API access
    RewriteCond %{REQUEST_URI} wp-json
    RewriteRule ^(.*)$ - [L]
</IfModule>

# Disable directory browsing
Options -Indexes

# Limit file upload size (adjust as needed)
<IfModule mod_php7.c>
    php_value upload_max_filesize 10M
    php_value post_max_size 10M
    php_value max_execution_time 300
    php_value max_input_vars 3000
</IfModule>

# Rate limiting for API endpoints (if mod_security or similar is available)
<IfModule mod_security.c>
    SecRule REQUEST_URI "@beginsWith /wp-json/renovalink/v1/contact" \
        "id:1001,phase:1,block,msg:'Contact form rate limit',\
         setvar:ip.contact_requests=+1,expirevar:ip.contact_requests=3600,\
         chain"
    SecRule IP:CONTACT_REQUESTS "@gt 5" "block"
</IfModule>

# Prevent access to PHP error logs
<Files "error_log">
    Order Allow,Deny
    Deny from all
</Files>

<Files "*.log">
    Order Allow,Deny
    Deny from all
</Files>

# Block common exploit attempts
<IfModule mod_rewrite.c>
    RewriteCond %{QUERY_STRING} (eval\() [NC,OR]
    RewriteCond %{QUERY_STRING} (127\.0\.0\.1) [NC,OR]
    RewriteCond %{QUERY_STRING} (localhost) [NC,OR]
    RewriteCond %{QUERY_STRING} (<|%3C).*script.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} proc/self/environ [OR]
    RewriteCond %{QUERY_STRING} mosConfig_[a-zA-Z_]{1,21}(=|\%3D) [OR]
    RewriteCond %{QUERY_STRING} base64_(en|de)code\(.*\) [OR]
    RewriteCond %{QUERY_STRING} (\<|%3C).*script.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (\<|%3C).*iframe.*(\>|%3E) [NC]
    RewriteRule ^(.*)$ - [F,L]
</IfModule>

# Optimize for headless setup - remove unnecessary WordPress features
<IfModule mod_rewrite.c>
    # Block xmlrpc.php
    RewriteRule ^xmlrpc\.php$ - [F,L]
    
    # Block wp-trackback.php
    RewriteRule ^wp-trackback\.php$ - [F,L]
    
    # Block wp-comments-post.php (no comments in headless)
    RewriteRule ^wp-comments-post\.php$ - [F,L]
</IfModule>